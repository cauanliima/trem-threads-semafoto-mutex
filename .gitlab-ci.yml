image: mcr.microsoft.com/dotnet/sdk:5.0

stages:
  - Compilação
  - Dockerização
  - Implantação

Construir e empacotar DLLs (qualidade):
  stage: Compilação
  before_script:
    - dotnet restore
  script: 
    - dotnet publish -c release -o ./Release --no-restore /p:Version="$(bash ./.ci/get-versao.sh 2>/dev/null)"
  artifacts: 
    paths:
      - Release/
  except:
    - tags

Construir e empacotar DLLs:
  stage: Compilação
  before_script:
    - dotnet restore
  script: 
    - dotnet publish -c release -o ./Release --no-restore /p:Version="$CI_COMMIT_TAG"
  artifacts: 
    paths:
      - Release/
  only:
    - tags

Dockerizar versão mais recente:
  image: docker
  services:
    - docker:dind
  stage: Dockerização
  script:
    - docker build -t harbor.chesf.gov.br/dgcds/compras:dev .
    - docker login -u $HARBOR_USER -p $HARBOR_PASSWORD harbor.chesf.gov.br
    - docker push harbor.chesf.gov.br/dgcds/compras:dev
  only:
    - develop
  dependencies:
    - Construir e empacotar DLLs (qualidade)

Dockerizar tag:
  image: docker
  stage: Dockerização
  services:
    - docker:dind
  script:
    - docker build -t harbor.chesf.gov.br/dgcds/compras:$CI_COMMIT_TAG .
    - docker login -u $HARBOR_USER -p $HARBOR_PASSWORD harbor.chesf.gov.br
    - docker push harbor.chesf.gov.br/dgcds/compras:$CI_COMMIT_TAG
  only:
    - tags
  dependencies:
    - Construir e empacotar DLLs

Implantar aplicação no Rancher:
  image: logapenvironment/rancher
  stage: Implantação
  environment:
    name: qualidade
  script:
    - rancher login $RANCHER_API_URL --token $RANCHER_BEARER_TOKEN --context $RANCHER_PROJECT_ID
    - rancher context switch DGCDS
    - rancher kubectl rollout restart deployment/compras-dev --namespace compras
  only:
    - develop
  dependencies:
    - Dockerizar versão mais recente
